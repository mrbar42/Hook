(function(e){"use strict";var n=function(e){var n,o,r,t=Object.create(null),i={},c=6e4,a={},u=[],s=e||"_hook",f=s+":request",l=s+":response",d=s+":hello:request",h=s+":hello:response";t.TIMEOUT="TIMEOUT",t.INVALID_MESSAGE="INVALID_MESSAGE",t.NO_HANDLERS="NO_HANDLERS",t.NO_SOCKET_BIND="NO_SOCKET_BIND",t.INTERNAL_ERROR="INTERNAL_ERROR";var v=function(e){var n=e&&e.rand;if(n&&i[n]){var o=i[n];o.active&&(e.error?o.reject(e.error):o.resolve(e.body))}},m=function(e,n){var r=n&&n.rand;return Promise.resolve().then(function(){if(n&&n.isInvalid)throw t.INVALID_MESSAGE;if(!n)throw t.INVALID_MESSAGE;if(!r)throw t.INVALID_MESSAGE;var i=n.action;if(!i)throw t.INVALID_MESSAGE;var c=Promise.resolve(n.body);if(!a[i]&&!u.length)throw console.warn("No handler was registered for '%s' action. ignoring message",i),t.NO_HANDLERS;var s=[n.body,e];o&&(c=c.then(function(n){return new Promise(function(r,t){try{var c=o(i,n,e);Promise.resolve(c).then(function(e){void 0!==e&&(s=s.concat(e)),r()})["catch"](t)}catch(a){t(a)}})}));var f;return u.length&&(c=c.then(function(){var e=Promise.resolve(),n=[i].concat(s);return u.forEach(function(o){e=e.then(function(){return o.apply(null,n)}).then(function(e){e&&(f=e)})}),e})),a[i]&&(c=c.then(function(){var e=Promise.resolve();return a[i].forEach(function(n){e=e.then(function(){return n.apply(null,s)}).then(function(e){e&&(f=e)})}),e})),c.then(function(e){return{body:f||e}})})["catch"](function(e){var n=e;return e instanceof Error&&(n=t.INTERNAL_ERROR,console.error("Error while processing RemoteHook: \n"+(e.stack||e.message||e))),{error:n}}).then(function(n){r&&(n.rand=r,e.emit(l,n))})},E=function(e,o){var r=Array.prototype.slice.call(arguments);e=r.shift(),o=r.shift();var i=o&&o.rand,c=Promise.resolve({body:{}});return c=c.then(function(){if(!n)throw t.NO_HANDLERS;return n(o.body,e)}),c.then(function(e){return{body:e}})["catch"](function(e){var n=e;return e instanceof Error&&(n=t.INTERNAL_ERROR,console.error("Error while processing RemoteHook: \n"+(e.stack||e.message||e))),{error:n}}).then(function(n){i&&(n.rand=i,e.emit(l,n))})},p=function(e,n,o,r,a){for(var u;!u;){var s=Math.random().toString(36).substr(2);i[u]||(u=s)}var f=i[u]={active:!0};return new Promise(function(s,l){f.resolve=function(e){f.active&&(f.active=!1,clearTimeout(f.timer),delete i[u],s(e))},f.reject=function(e){f.active&&(f.active=!1,clearTimeout(f.timer),delete i[u],l(e))},f.active=!0,0!==a&&(f.timer=setTimeout(function(){f.active&&f.reject(t.TIMEOUT)},a||c));var d={rand:u,action:o,body:r};e.emit(n,d)})};return t.onHello=function(e){return n&&console.error("called onHello more than once"),e&&"function"==typeof e?n=e:console.warn("Invalid handler for 'onHello' method. must be a function. [%s]",typeof e),t},t.onHook=function(e){return o?console.error("called onHook more than once"):o=e,t},t.bindSocket=function(e){return e&&"object"==typeof e?r=e:console.warn("Hook#bindSocket - Invalid socket",e),t},t.attach=function(e){return e.on(d,function(n){E(e,n)}),e.on(h,v),e.on(f,function(n){m(e,n)}),e.on(l,v),t},t.on=function(e,n){switch(e&&typeof e){case"function":u.push(e);break;case"string":if(!n||"function"!=typeof n){console.warn("An handler is must be provided when calling 'on' method. ({string} action, {function} handler)");break}a[e]||(a[e]=[]),a[e].push(n);break;case"object":Object.keys(e).forEach(function(n){return e[n]&&"function"==typeof e[n]?(a[n]||(a[n]=[]),void a[n].push(e[n])):void console.warn("An handler is must be provided for each action when calling 'on method'. ({string} action, {function} handler)")});break;default:console.warn("Called 'commands' property with invalid argument [%s] %s",typeof e,e)}return t},t.sendTo=function(e,n,o,r){return p(e,f,n,o,r)},t.send=function(e,n,o){return r?p(r,f,e,n,o):Promise.reject(t.NO_SOCKET_BIND)},t.sendHelloTo=function(e,n){return p(e,d,"hello",n)},t.sendHello=function(e){return r?p(r,d,"hello",e):Promise.reject(t.NO_SOCKET_BIND)},t};"undefined"!=typeof define&&define.amd?define(function(){return n}):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?exports=module.exports=n:exports.Hook=n:e.Hook=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:this||{});
