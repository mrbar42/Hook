(function(e){"use strict";function n(e){if(!(this instanceof n))return new n(e);var o,r,t,i=this,c={},a=6e4,u={},s=[],f=e||"_hook",l=f+":request",d=f+":response",h=f+":hello:request",v=f+":hello:response";i.TIMEOUT="TIMEOUT",i.INVALID_MESSAGE="INVALID_MESSAGE",i.NO_HANDLERS="NO_HANDLERS",i.NO_SOCKET_BIND="NO_SOCKET_BIND",i.INTERNAL_ERROR="INTERNAL_ERROR";var m=function(e){var n=e&&e.rand;if(n&&c[n]){var o=c[n];o.active&&(e.error?o.reject(e.error):o.resolve(e.body))}},E=function(e,n){var o=n&&n.rand;return Promise.resolve().then(function(){if(!n)throw i.INVALID_MESSAGE;if(!o)throw i.INVALID_MESSAGE;var t=n.action;if(!t)throw i.INVALID_MESSAGE;var c=Promise.resolve(n.body);if(!u[t]&&!s.length)throw console.warn("No handler was registered for '%s' action. ignoring message",t),i.NO_HANDLERS;var a=[n.body,e];r&&(c=c.then(function(n){return new Promise(function(o,i){try{var c=r(t,n,e);Promise.resolve(c).then(function(e){void 0!==e&&(a=a.concat(e)),o()})["catch"](i)}catch(u){i(u)}})}));var f;return s.length&&(c=c.then(function(){var e=Promise.resolve(),n=[t].concat(a);return s.forEach(function(o){e=e.then(function(){return o.apply(null,n)}).then(function(e){e&&(f=e)})}),e})),u[t]&&(c=c.then(function(){var e=Promise.resolve();return u[t].forEach(function(n){e=e.then(function(){return n.apply(null,a)}).then(function(e){e&&(f=e)})}),e})),c.then(function(e){return{body:f||e}})})["catch"](function(e){var n=e;return e instanceof Error&&(n=i.INTERNAL_ERROR,console.error("Error while processing RemoteHook: \n"+(e.stack||e.message||e))),{error:n}}).then(function(n){o&&(n.rand=o,e.emit(d,n))})},p=function(e,n){var r=Array.prototype.slice.call(arguments);e=r.shift(),n=r.shift();var t=n&&n.rand,c=Promise.resolve({body:{}});return c=c.then(function(){if(!o)throw i.NO_HANDLERS;return o(n.body,e)}),c.then(function(e){return{body:e}})["catch"](function(e){var n=e;return e instanceof Error&&(n=i.INTERNAL_ERROR,console.error("Error while processing RemoteHook: \n"+(e.stack||e.message||e))),{error:n}}).then(function(n){t&&(n.rand=t,e.emit(d,n))})},N=function(e,n,o,r,t){for(var u;!u;){var s=Math.random().toString(36).substr(2);c[u]||(u=s)}var f=c[u]={active:!0};return new Promise(function(s,l){f.resolve=function(e){f.active&&(f.active=!1,clearTimeout(f.timer),delete c[u],s(e))},f.reject=function(e){f.active&&(f.active=!1,clearTimeout(f.timer),delete c[u],l(e))},f.active=!0,0!==t&&(f.timer=setTimeout(function(){f.active&&f.reject(i.TIMEOUT)},t||a));var d={rand:u,action:o,body:r};e.emit(n,d)})};return i.onHello=function(e){return o&&console.error("called onHello more than once"),e&&"function"==typeof e?o=e:console.warn("Invalid handler for 'onHello' method. must be a function. [%s]",typeof e),i},i.onHook=function(e){return r?console.error("called onHook more than once"):r=e,i},i.bindSocket=function(e){return e&&"object"==typeof e?t=e:console.warn("Hook#bindSocket - Invalid socket",e),i},i.attach=function(e){return e.on(h,function(n){p(e,n)}),e.on(v,m),e.on(l,function(n){E(e,n)}),e.on(d,m),i},i.on=function(e,n){switch(e&&typeof e){case"function":s.push(e);break;case"string":if(!n||"function"!=typeof n){console.warn("An handler is must be provided when calling 'on' method. ({string} action, {function} handler)");break}u[e]||(u[e]=[]),u[e].push(n);break;case"object":Object.keys(e).forEach(function(n){return e[n]&&"function"==typeof e[n]?(u[n]||(u[n]=[]),void u[n].push(e[n])):void console.warn("An handler is must be provided for each action when calling 'on method'. ({string} action, {function} handler)")});break;default:console.warn("Called 'commands' property with invalid argument [%s] %s",typeof e,e)}return i},i.sendTo=function(e,n,o,r){return N(e,l,n,o,r)},i.send=function(e,n,o){return t?N(t,l,e,n,o):Promise.reject(i.NO_SOCKET_BIND)},i.sendHelloTo=function(e,n){return N(e,h,"hello",n)},i.sendHello=function(e){return t?N(t,h,"hello",e):Promise.reject(i.NO_SOCKET_BIND)},i}"undefined"!=typeof define&&define.amd?define(function(){return n}):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?exports=module.exports=n:exports.Hook=n:e.Hook=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:this||{});
